name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # lint:
  #   name: Lint & Format Check
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Cache pip packages
  #       uses: actions/cache@v3
  #       with:
  #         path: ~/.cache/pip
  #         key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
  #         restore-keys: |
  #           ${{ runner.os }}-pip-

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install ruff black isort mypy

  #     - name: Run Ruff (linter)
  #       run: |
  #         ruff check app/ --output-format=github
  #       continue-on-error: true

  #     - name: Run Black (formatter check)
  #       run: |
  #         black --check app/

  #     - name: Run isort (import sorting check)
  #       run: |
  #         isort --check-only app/

  #     - name: Run MyPy (type checking)
  #       run: |
  #         mypy app/ --ignore-missing-imports
  #       continue-on-error: true

  # security:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install bandit safety

  #     - name: Run Bandit (security linter)
  #       run: |
  #         bandit -r app/ -f json -o bandit-report.json
  #       continue-on-error: true

  #     - name: Run Safety (dependency vulnerability check)
  #       run: |
  #         safety check --json
  #       continue-on-error: true

  #     - name: Upload security reports
  #       uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: security-reports
  #         path: |
  #           bandit-report.json

  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt

  #     - name: Run tests
  #       run: |
  #         pytest

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    # needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t schedule-api:${{ github.sha }} .
          docker tag schedule-api:${{ github.sha }} schedule-api:latest

      - name: Export Docker image as tarball
        run: |
          docker save schedule-api:latest -o schedule-api.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: schedule-api.tar
          retention-days: 1
          if-no-files-found: error

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ vars.SERVER_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v5
        with:
          name: docker-image
          path: .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            schedule-api.tar \
            docker-compose.yml \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/"

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << EOF
          set -e

          cd "${{ secrets.DEPLOY_PATH }}"

          docker load -i schedule-api.tar
          docker compose run --rm api alembic upgrade head || echo "No migrations step configured"
          docker compose up -d --force-recreate api
          docker image prune -f

          sleep 5
          curl -f http://localhost:8000/health || exit 1

          echo "Deployment successful!"
          EOF

      - name: Cleanup local SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi