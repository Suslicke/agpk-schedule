name: Simple Deploy

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è: –ø—Ä–∏ push –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches: [ main ]

jobs:
  # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest

    steps:
      # –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # –®–ê–ì 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
      - name: üîê Setup SSH
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è SSH –∫–ª—é—á–µ–π
          mkdir -p ~/.ssh

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
          chmod 600 ~/.ssh/deploy_key

          # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –≤ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–æ—Å—Ç—ã (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏)
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # –®–ê–ì 3: –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üì§ Copy files to server
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º rsync –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
          # –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–Ω—É–∂–Ω–æ–µ (.git, .github, __pycache__, –∏ —Ç.–¥.)
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='venv' \
            --exclude='.venv' \
            --exclude='logs/' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      # –®–ê–ì 4: –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üê≥ Run docker-compose
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'

          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd ${{ secrets.DEPLOY_PATH }}

          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          docker-compose down || true

          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          docker-compose run --rm web alembic upgrade head

          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–µ
          docker-compose up -d --build

          # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ (5 —Å–µ–∫—É–Ω–¥)
          echo "‚è≥ Waiting for services to start..."
          sleep 5

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo "üìä Container status:"
          docker-compose ps

          ENDSSH

      # –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
      - name: ‚úÖ Health check
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'

          cd ${{ secrets.DEPLOY_PATH }}

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          echo "üè• Checking health..."
          if curl -f http://localhost:8000/health; then
            echo "‚úÖ Application is healthy!"
          else
            echo "‚ùå Health check failed!"
            echo "üìã Container logs:"
            docker-compose logs --tail=50 web
            exit 1
          fi

          ENDSSH

      # –®–ê–ì 6: –û—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª—è–µ–º SSH –∫–ª—é—á)
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      # –®–ê–ì 7: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      - name: üéâ Success
        if: success()
        run: |
          echo "================================"
          echo "‚úÖ Deployment successful!"
          echo "üåê Application URL: ${{ secrets.SERVER_URL }}"
          echo "================================"
